<!-- ordem-servico.component.html -->
<h1 class="text-center text-2xl font-bold my-4">Ordens de Serviço</h1>

<div class="flex justify-end mb-3">
  <button pButton type="button" label="Nova Ordem" icon="pi pi-plus" (click)="showDialogToAdd()"></button>
</div>

<p-table
  [value]="ordens"
  dataKey="numero"
  [paginator]="true"
  [rows]="10"
>
  <ng-template pTemplate="header">
    <tr>
      <th>Número</th>
      <th>Data</th>
      <th>Status</th>
      <th>Placa</th>
      <th>Cliente</th>
      <th>Ações</th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-os>
    <tr>
      <td>{{ os.numero }}</td>
      <td>{{ os.data | date:'dd/MM/yyyy' }}</td>
      <td>{{ os.status }}</td>
      <td>{{ os.placaVeiculo?.placa }}</td>
      <td>{{ os.cliente?.nome }}</td>
      <td class="flex gap-1">
        <button pButton icon="pi pi-file-pdf" (click)="downloadPdf(os.numero)" class="p-button-rounded p-button-danger"></button>
        <button pButton icon="pi pi-pencil" (click)="editar(os)" class="p-button-rounded p-button-success"></button>
      </td>
    </tr>
  </ng-template>
</p-table>

<p-dialog
  header="{{ isEdit ? 'Editar Ordem' : 'Nova Ordem' }}"
  [(visible)]="displayDialog"
  [modal]="true"
  [style]="{ width: '800px', height: 'auto' }"
  [responsive]="true"
>
    <div class="grid">
      <div class="col-6 p-field mb-4">
        <p-floatLabel variant="in">
          <p-select
            [options]="statusOptions"
            [(ngModel)]="ordem.status"
            optionLabel="label"
            styleClass="w-full"
          ></p-select>
          <label>Status</label>
        </p-floatLabel>
      </div>

    <div class="col-6 p-field mb-4">
      <p-floatLabel variant="in">
        <p-select
          [options]="clientes"
          [(ngModel)]="ordem.idCliente"
          optionLabel="nome"
          optionValue="id"
          styleClass="w-full"
        ></p-select>
        <label>Cliente</label>
      </p-floatLabel>
    </div>
  
    <div class="col-6 p-field mb-4">
      <p-floatLabel variant="in">
        <p-select
          [options]="veiculos"
          [(ngModel)]="ordem.placaVeiculo"
          optionLabel="placa"
          styleClass="w-full"
        ></p-select>
        <label>Veículo</label>
      </p-floatLabel>
    </div>
  </div>

  <p-tabView>
    <!-- Aba de Serviços -->
    <p-tabPanel header="Serviços">
      <p-pickList
        [source]="servicos"
        [target]="ordem.itensServico"
        sourceHeader="Disponíveis"
        targetHeader="Selecionados"
        itemSize="5"
        styleClass="min-height:250px"
        [dragdrop]="false"
        [showSourceFilter]="true"
        [showTargetFilter]="true"
        filterBy="nome,preco"
      >
        <!-- Template dos itens na coluna de disponíveis -->
        <ng-template let-servico pTemplate="item">
          <div class="p-grid p-align-center">
            <div class="p-col-8">{{ servico.nome }}</div>
            <div class="p-col-4 text-right">{{ servico.preco | currency:'BRL':'symbol' }}</div>
          </div>
        </ng-template>
  
        <!-- Template dos itens na coluna de selecionados -->
        <ng-template let-servico pTemplate="selectedItems">
          <div class="p-grid p-align-center">
            <div class="p-col-6">{{ servico.nome }}</div>
            <div class="p-col-6 text-right">{{ servico.precoUnitario | currency:'BRL':'symbol' }}</div>
          </div>
        </ng-template>
      </p-pickList>
    </p-tabPanel>
  
    <!-- Aba de Peças -->
    <p-tabPanel header="Peças">
      <div class="p-col-12">
        <label class="p-mb-2"><b>PEÇAS USADAS</b></label>
        <p-table [value]="itensPeca" editable="true" dataKey="idPeca">
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 50%">Peça</th>
              <th style="width: 30%">Quantidade</th>
              <th style="width: 20%">Ações</th>
            </tr>
          </ng-template>
    
          <ng-template pTemplate="body" let-item let-ri="rowIndex">
            <tr>
              <!-- Dropdown de seleção de peça -->
              <td pEditableColumn>
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <p-dropdown
                      [options]="pecas"
                      optionLabel="nome"
                      [(ngModel)]="item.idPeca"
                      [style]="{ width: '100%' }"
                      [filter]="true"
                      placeholder="Selecione"
                    ></p-dropdown>
                  </ng-template>
                  <ng-template pTemplate="output">
                    {{ item.idPeca?.nome || '—' }}
                  </ng-template>
                </p-cellEditor>
              </td>
    
              <!-- Input de quantidade -->
              <td pEditableColumn>
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <p-inputNumber
                      [(ngModel)]="item.quantidade"
                      [min]="1"
                      [showButtons]="true"
                      [style]="{ width: '100%' }"
                    ></p-inputNumber>
                  </ng-template>
                  <ng-template pTemplate="output">
                    {{ item.quantidade }}
                  </ng-template>
                </p-cellEditor>
              </td>
    
              <!-- Botão de remover -->
              <td class="text-center">
                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-text p-button-danger"
                ></button>
              </td>
            </tr>
          </ng-template>
    
          <!-- Footer com botão de adicionar -->
          <ng-template pTemplate="footer">
            <tr>
              <td colspan="3" class="text-right">
                <button
                  pButton
                  type="button"
                  icon="pi pi-plus"
                  label="Adicionar Peça"
                  class="p-button-text"
                ></button>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </p-tabPanel>
  </p-tabView>
  

  <ng-template pTemplate="footer">
    <button
      pButton
      label="Cancelar"
      icon="pi pi-times"
      (click)="displayDialog = false"
      class="p-button-text"
    ></button>
    <button
      pButton
      label="Salvar"
      icon="pi pi-check"
      (click)="salvar()"
      [disabled]="
        !ordem.status ||
        !ordem.placaVeiculo ||
        !ordem.idCliente      "
    ></button>
  </ng-template>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
